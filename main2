#include<stdio.h>
#include<stdlib.h>
#include<string>
#include <math.h>
#include <locale.h>
#include <conio.h>
#include<time.h>

#define TAM 50
#define MAX 100
#define USUARIO1 "j.tabad"
#define USUARIO2 "j.tovar"
#define USUARIO3 "a.sanchez"
#define CLAVE1 "edcrfv"
#define CLAVE2 "qazwsx"
#define CLAVE3 "tgbyhn"
#define INTENTOSMAX 3

typedef struct
{
    char nombre[TAM];
    int Num_matricula;
    char Titulacion[TAM];
    char correo[TAM];
    int asig;
    char asignaturas[TAM];
    int i;
    int op;
}Alumno;

typedef struct {
    char usuario[TAM];
    char clave[TAM];
    char re_clave[TAM];
    char n_usuario[TAM];
    char n_clave[TAM];
   
}Intro;

//AQUI FUNCIONES

int leer_entero(void);
void creacion_usuario_1(Alumno[], int);
void creacion_usuario_2(Intro[], int);
int menu(void);
void menu_alumno(Alumno[], int);
void intro_1(Intro* cuenta1);
void listado_agenda(Alumno[], int);
int  alta_Alumno(Alumno[], int);
void crear_fichero_txt(Alumno[], int);
void crear_fichero_bin(Alumno[], int);
int leer_fichero_txt(Alumno[]);
int leer_fichero_bin(Alumno[]);

int main()
{
    setlocale(LC_CTYPE, "es-ES");
    Alumno uno;


    //Aqui irá arduino y declaración de variables

    char tecla;
    int opcion;
    Alumno cuenta1[TAM];
    Intro cuenta2[TAM];





    //Comienzo de lo que se ve en pantalla


    printf("=========Bienvenido a la ETSIDI=========\n\n Pulse cualquier tecla para continuar");

    tecla = _getch();

    system("cls"); //LImpia lo q hay en pantalla

    do
    {
        printf("Seleccione como quiere iniciar sesión:\n\n 1.Iniciar sesión como Administrador.\n 2.Iniciar sesión como estudiante.\n 3.Salir.");

        opcion = leer_entero(); //funcion para elegir opcion

        system("cls");

        if (opcion == 1 || opcion == 2 || opcion == 3)//solo entra al menu si se introduce uno de estos valores
        {
            if (opcion == 1)
            {
                //printf("opcion1\n");

                do
                {
                    Alumno agenda[MAX];
                    int nAlumnos = 0;
                    int opcion1;

                    setlocale(LC_CTYPE, "es-ES");
                    nAlumnos = leer_fichero_txt(agenda);


                    do
                    {
                        opcion1 = menu();
                        switch (opcion1)
                        {
                        case 1:
                            nAlumnos = alta_Alumno(agenda, nAlumnos);
                            break;
                        case 2:
                            listado_agenda(agenda, nAlumnos);
                            break;
                        case 3:
                            opcion == 0;
                            break;
                        default:
                            printf("Opción incorrecta\n");
                        }
                    } while (opcion1 != 3);
                    crear_fichero_txt(agenda, nAlumnos);
                    crear_fichero_bin(agenda, nAlumnos);
                    return 0;

                } while (opcion == 1);



            }
            if (opcion == 2)
            {
                int nAlumnos = 0;
                int x = 0;
                //creacion_usuario_2(cuenta2, nAlumnos);
                printf("1.Iniciar sesión\n");
                printf("2.Crear cuenta\n");
                printf("Elija una opción de las siguientes: ");
                scanf_s("%d", &x);
                if (x == 1) {
                    intro_1(cuenta2);
                    menu_alumno(cuenta1, nAlumnos);
                }
                if (x == 2);
                {
                    creacion_usuario_2(cuenta2, nAlumnos);
                    intro_1(cuenta2);
                    menu_alumno(cuenta1, nAlumnos);
                }
                
            }

        }
        else
        {
            printf("\n\n\nUsted ha introduciod un valor incorrecto, porfavor introduzca un valor válido\n\n\n");
        }

    } while (opcion != 3);

}

int leer_entero(void) { //con esta funcion evito sobrecargas al leer enteros y que quede en bucle el programa
    char cadena[2];
    int numero;
    gets_s(cadena);
    numero = atoi(cadena);//si hay un entero en la cadena se le asigana a num, sino, le asigna 0.
    return (numero);
}
int menu(void)
{
    int op;
    char intro;
    printf("\n");
    printf("1. Crear alumno\n");
    printf("2. Listado de Alumnos\n");
    printf("3. Salir del programa\n");
    printf("Opción=");
    scanf_s("%d", &op);
    scanf_s("%c", &intro, 1);
    return op;
}

void listado_agenda(Alumno a[], int n)
{
    int i;
    setlocale(LC_CTYPE, "es-ES");
    printf("\nEl contenido del listado es:\n");
    printf("\n=============================\n");
    for (i = 0; i < n; i++)
    {
        printf("Nombre =%s\n", a[i].nombre);
        printf("Número de matricula =%d\n", a[i].Num_matricula);
        printf("Titulación =%s\n", a[i].Titulacion);
        printf("Correo institucional =%s\n", a[i].correo);
        printf("==============\n");
    }
}

void crear_fichero_txt(Alumno a[], int n)
{
    FILE* fichero;
    int i;
    setlocale(LC_CTYPE, "es-ES");
    errno_t e;
    e = fopen_s(&fichero, "Agenda.txt", "wt");
    if (fichero == NULL)
        printf("No se ha podido guardar\n");
    else
    {
        for (i = 0; i < n; i++)
        {
            fprintf(fichero, "%s\n", a[i].nombre);
            fprintf(fichero, "%d\n", a[i].Num_matricula);
            fprintf(fichero, "%s\n", a[i].Titulacion);
            fprintf(fichero, "%s\n", a[i].correo);
        }
        fclose(fichero);
    }

}

void crear_fichero_bin(Alumno a[], int n)
{
    FILE* fichero;
    errno_t e;
    setlocale(LC_CTYPE, "es-ES");
    e = fopen_s(&fichero, "Agenda.dat", "wb");
    if (fichero == NULL)
        printf("No se ha podido guardar\n");
    else
    {
        fwrite(&n, sizeof(int), 1, fichero);
        fwrite(a, sizeof(Alumno), n, fichero);
        fclose(fichero);
    }
}

int leer_fichero_txt(Alumno a[])
{
    setlocale(LC_CTYPE, "es-ES");
    FILE* fichero;
    int n = 0;
    errno_t e;
    char* p;
    e = fopen_s(&fichero, "Agenda.txt", "rt");
    if (fichero == NULL)
        printf("La lista estaba vacía\n");
    else
    {
        fgets(a[n].nombre, TAM, fichero);

        while (!feof(fichero))
        {
            p = strchr(a[n].nombre, '\n');
            *p = '\0';

            fscanf_s(fichero, "%d\n", &a[n].Num_matricula);
            fgets(a[n].Titulacion, TAM, fichero);
            fgets(a[n].correo, TAM, fichero);
            n++;
            fgets(a[n].nombre, TAM, fichero);
            fscanf_s(fichero, "%d\n", &a[n].Num_matricula);
            fgets(a[n].Titulacion, TAM, fichero);
            fgets(a[n].correo, TAM, fichero);
        }
        fclose(fichero);
    }
    return n;
}

int leer_fichero_bin(Alumno a[])
{
    setlocale(LC_CTYPE, "es-ES");
    FILE* fichero;
    int n = 0;
    errno_t e;

    e = fopen_s(&fichero, "Agenda.dat", "rb");
    if (fichero == NULL)
        printf("La agenda estaba vacía\n");
    else
    {
        fread(&n, sizeof(int), 1, fichero);
        fread(a, sizeof(Alumno), n, fichero);
        fclose(fichero);
    }
    return n;
}


int alta_Alumno(Alumno a[], int n)
{
    setlocale(LC_CTYPE, "es-ES");
    if (n < MAX)
    {
        printf("Nombre =");
        scanf_s("%s", a[n].nombre, TAM);
        printf("Número de matricula =");
        scanf_s("%d", &a[n].Num_matricula);
        printf("Titulación =");
        scanf_s("%s", &a[n].Titulacion, TAM);
        printf("Correo institucional =");
        scanf_s("%s", &a[n].correo, TAM);
        n++;
    }
    else
        printf("Agenda completa\n");
    return n;
}
void creacion_usuario_1(Alumno cuenta1[], int n) {
    printf("Escriba los datos que se le piden a continuación\n");

    if (n < MAX)
    {
        printf("Nombre:");
        scanf_s("%s", &cuenta1[n].nombre, TAM);

        printf("Num_matricula:");
        scanf_s("d", &cuenta1[n].Num_matricula);

        printf("Correo institucional:");
        scanf_s("%s", &cuenta1[n].nombre, TAM);

        printf("Titulación:");
        scanf_s("%s", &cuenta1[n].nombre, TAM);
    }
    //Comprobamos si las fechas son validas
}

void creacion_usuario_2(Intro cuenta2[], int n) {
    int j = 0, largo = 0, m = 0, k;
    if (n < MAX)
    {
        printf("Usuario:");
        scanf_s("%s", &cuenta2[n].usuario, TAM);
        printf("Contraseña: (minimo 8 caracteres):");
        scanf_s("%s", &cuenta2[n].clave, TAM);



        while (cuenta2[n].clave[j] != '\0')
        {
            largo++;
            if (cuenta2[n].clave[j] == ' ')
                largo--;
            j++;
        }

        if (j < 8) {
            printf("Obligatorio 8 caracteres\n");
            printf("Contraseña:");
            scanf_s("%s", &cuenta2[n].clave, TAM);
        }

        printf("Confirmar contraseña:");
        scanf_s("%s", &cuenta2[n].re_clave, TAM);

        if (strcmp(cuenta2[n].clave, cuenta2[n].re_clave) == 0) { //&& strcmp(cuenta1->contraseña, cuenta1->re_clave) == 0
            m = 1;
        }
        else {
            printf("Las contraseñas no coinciden");
            printf("\nRepetir contraseña:");
            scanf_s("%s", &cuenta2[n].re_clave, TAM);
        }
        if (m == 1) {
            strcpy_s(cuenta2[n].n_usuario, cuenta2[n].usuario);
            strcpy_s(cuenta2[n].n_clave, cuenta2[n].clave);
            printf("Pulse cualquier tecla para continuar");
            k = getchar();
        }
    }
}

void menu_alumno(Alumno cuenta1[], int n) {
    cuenta1[n].op = 5;
    char enter;
    if (n < MAX)
    {
        while (cuenta1[n].op <= 5) {
            printf("\n=========Bienvenido a la ETSISDI=========\n\n");
            printf("\tSeleccione una opción: \n");
            printf("\n\t1.Perfil");
            printf("\n\t2.Asignaturas");
            printf("\n\t3.Entregas pendientes");
            printf("\n\t4.Expediente:");
            printf("\n\t5.Salir\n");
            scanf_s("%d", &cuenta1[n].op);
            if (cuenta1[n].op == 1) {
                system("cls");
                printf("Nombre: ");
                printf("\tNumero matricula: ");
                printf("\nClase: ");
                printf("\nCorreo institucional: \n\n");
                printf("Desea volver al menu, pulse enter");
                scanf_s("%c", &enter);
                if (enter == '\0') {
                    system("cls");
                    cuenta1[n].op = 5;
                }
            }
            if (cuenta1[n].op == 2) {
                system("cls");
                printf("Seleccione la asignatura:");
                printf("\n1.Asignatura 1");
                printf("\n2.Asignatura 2");
                printf("\n3.Asignatura 3");
                printf("\n4.Asignatura 4");
                printf("\n5.Asignatura 5");
                scanf_s("%d", &cuenta1[n].asig);
                if (cuenta1[n].asig == 1) {
                    printf("El siguiente examen es X\n");
                    printf("No tienes tareas pendientes\n\n");
                }
                if (cuenta1[n].asig == 2) {
                    printf("El siguiente examen es X\n");
                    printf("No tienes tareas pendientes\n\n");
                }
                if (cuenta1[n].asig == 3) {
                    printf("El siguiente examen es X\n");
                    printf("No tienes tareas pendientes\n\n");
                }
                if (cuenta1[n].asig == 4) {
                    printf("El siguiente examen es X\n");
                    printf("No tienes tareas pendientes\n\n");
                }
                if (cuenta1[n].asig == 5) {
                    printf("El siguiente examen es X\n");
                    printf("No tienes tareas pendientes\n\n");
                }

            }
            if (cuenta1[n].op == 3) {
                system("cls");
                printf("Tarea x --> fecha");
                printf("\nTarea y --> fecha\n\n");

            }
            if (cuenta1[n].op == 4) {
                system("cls");
                printf("Créditos obtenidos: \n\n");

            }
            if (cuenta1[n].op == 5) {
                printf("Hasta la próxima.\n\n");

            }
            if (cuenta1[n].op > 5) {
                printf("\nIndique una opción de las indicadas: \n\n");
                cuenta1[n].op = 5;
            }
        }
    }
}
void intro_1(Intro* cuenta2) { //se crea la cuenta de un doctor
    int k = 0, intento = 0;
    do {
        system("cls");
        printf("\n\t\t\tIntroduzca sus credenciales\n");
        printf("\n\tUSUARIO: ");
        gets_s(cuenta2->usuario);
        printf("\n\tCLAVE: ");
        gets_s(cuenta2->clave);


        if (strcmp(cuenta2->usuario, USUARIO1) == 0 && strcmp(cuenta2->clave, CLAVE1) == 0 || strcmp(cuenta2->usuario, USUARIO2) == 0 && strcmp(cuenta2->clave, CLAVE2) == 0 || strcmp(cuenta2->usuario, USUARIO3) == 0 && strcmp(cuenta2->clave, CLAVE3) == 0 || strcmp(cuenta2->n_usuario, cuenta2->usuario) == 0 && strcmp(cuenta2->n_clave, cuenta2->clave) == 0)
            intento = 1;

        else {
            printf("\nEl nombre de usuario y/o la clave no son correctos\n");
            k++;
            printf("\nHa consumido %d de sus 5 intentos\n", k);
            getchar();
        }

    }

    while (k < INTENTOSMAX && intento == 0);

    if (intento == 1) {
        printf("\n\n\tBienvenido a la etsidi\n\n\n");

    }
    else {
        printf("\n\nHa alcanzado el numero maximo de intentos\n\n\n");
    }

}
